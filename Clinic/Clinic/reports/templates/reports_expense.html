{% extends 'base.html' %}
{% block content %}
{% if request.GET.error %}
    <p>{{request.GET.error}}</p>
{% endif %}
{% load static %}
{% if status != 'unknown' %}
    <!--{{status}}
    {{error}}
    {{data}}-->
{% endif %}
<script language="JavaScript">
    $( function() {

        $( ".datepicker" ).datepicker({ dateFormat: 'yy-mm-dd',
        shortYearCutoff: 1,
        changeMonth: true,
        changeYear: true,
        minDate: "-99Y",
         yearRange: "1900:2030"  });

        var table = $('#expense_report').DataTable({
            orderCellsTop: true,
            fixedHeader: true,
            pageLength: 50,
            searching: false

        });

        dt_width = $("#expense_report").width();

        $(".data_cell").css({"max-width": dt_width/10-20, "white-space":"nowrap", 'overflow-y':'scroll','scrollbar-width': 'none'});

        {% if added %}
            global_alert('Expense Added: {{added}}');
        {% endif %}

    });

      function check_form(){
        console.log(this);
        f = document.forms['addform'];
        title = f['title'].value;
        amount = f['amount'].value;
        paid = f['paid_amount'].value;
        due = f['due_amount'].value;
        if (title.length == 0 || amount.length == 0){
            alert("Title and Amount are mandatory.");
            return false;
        }
        else if (amount != paid + due) {
            alert("Amount paid + due should match total amount");
            return false;
        }
        else
            f.submit();
      }

      function refreshReport(action){
            if(action == 'F'){ //filter
                fields = {'filters':{}}
                categories = $("#catSelect").val();
                fromDate = $("#fromDate").val();
                toDate = $("#toDate").val();

                url = "./?categories="+categories+"&fromDate="+fromDate+"&toDate="+toDate;

                window.location = url;

            }
      }
</script>
<style>
    .data_cell::-webkit-scrollbar { width: 0px; height: 0%; background-color: gray; }
</style>
<h3>Reporting</h3>
<p><a href="/reports/revenue/">Revenue</a></p>
<p><a href="/reports/expense">Expense</a></p>
<p><a href="/reports/profit-loss/">Profit/Loss</a></p>

<h5>Expense Report</h5>
<table class="rbstable">
    <tr>
        <td>
            <b>Filters</b>
        </td>
    </tr>
    <tr>
        <td>
            <table width="100%">
                <tr>
                    <th></th>
                    <th>
                        Category
                    </th>

                    <th>
                        Expense Date
                    </th>
                    <th></th>
                </tr>
                <tr>
                    <td><div onclick="refreshReport('F')"><img src="{% static 'images/refresh.png' %}"></div></td>
                    <td>
                        <span>
                            <select name="resources" id="catSelect" class="selectpicker filterReport" multiple data-live-search="true" data-actions-box="true" >
                                <option value="unassigned">Un-assigned</option>
                                {% for row in types %}
                                    <option value="{{row.idmedicine_type}}" data-tokens="{{row.idmedicine_type}},{{row.name}}">{{row.name}}</option>
                                {% endfor   %}
                            </select>
                        </span>
                    </td>

                    <td>
                        <span>
                            <input type="text" placeholder="From" name="fromDate" id="fromDate" class="datepicker filterReport" style="width:99px">
                            <input style="width:99px" placeholder="To" class="datepicker filterReport" type="text" name="toDate" id="toDate">
                        </span>
                    </td>
                    <td><div onclick="refreshReport('F')"><img src="{% static 'images/refresh.png' %}"></div></td>
                </tr>
            </table>
        </td>
    </tr>
</table>

<div>
    <table id="expense_report" style="font-size:small">
        <thead>
            <tr>
                <th></th>
                <th>Title</th>
                <th>Category</th>
                <th>Expense Date</th>
                <th>Amount</th>
                <th>Paid</th>
                <th>Due</th>
                <th>Due Date</th>
                <th>Due on</th>
                <th>Bill No</th>
                <th>Record Created</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        {% for record in report.data %}
            <tr>
                <td>E</td>
                <td><div class="data_cell">{{record.title}}</div></td>
                <td><div class="data_cell">{{record.name}}</div></td>
                <td><div class="data_cell">{{record.expense_date|date:'d-M-Y'}}</div></td>
                <td><div class="data_cell">&#8377;{{record.amount}}</div></td>
                <td><div class="data_cell">&#8377;{{record.paid_amount}}</div></td>
                <td><div class="data_cell">&#8377;{{record.due_amount}}</div></td>
                <td><div class="data_cell">{{record.due_date|date:'d-M-Y'}}</div></td>
                <td><div class="data_cell">{{record.due_on}}</div></td>
                <td><div class="data_cell">{{record.bill_num}}</div></td>
                <td><div class="data_cell">{{record.dt_created|date:'d-M-Y'}}</div></td>
                <td>N</td>
            </tr>
        {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <th></th>
                <th></th>
                <th></th>
                <th></th>

                <th><div class="data_cell">&#8377; {{report.summary.0.amount}}</div></th>
                <th><div class="data_cell">&#8377; {{report.summary.0.paid_amount}}</div></th>
                <th><div class="data_cell">&#8377; {{report.summary.0.due_amount}}</div></th>

                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
            </tr>
        </tfoot>
    </table>
</div>
{% endblock %}